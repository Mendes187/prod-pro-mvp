<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>PROD PRO - Apontamento</title>

  <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2666/2666505.png">
  <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2666/2666505.png">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 text-gray-900">

  <nav class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-black flex items-center gap-2 tracking-tighter">
        <i data-lucide="clipboard-check" class="text-blue-500"></i>
        PROD <span class="text-blue-500">PRO</span>
      </h1>
      <div class="text-xs font-black text-slate-300">
        Data: <span id="todayLabel"></span>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-4 md:p-8 space-y-8">

    <section class="bg-white p-4 rounded-2xl border shadow-sm flex flex-wrap gap-3 items-center justify-between">
      <div>
        <div class="text-xs font-black uppercase text-gray-400">Data do apontamento</div>
        <input id="datePick" type="date" class="mt-1 border p-3 rounded-xl font-bold outline-none transition-all focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div class="flex gap-2">
        <button id="btnOntem" class="bg-slate-100 px-5 py-3 rounded-xl font-black hover:bg-slate-200">Ontem</button>
        <button id="btnHoje" class="bg-slate-900 text-white px-5 py-3 rounded-xl font-black hover:bg-black">Hoje</button>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400 text-[10px]">Máquinas - 1º Turno</div>
        <div class="text-3xl font-black mt-2 text-slate-800"><span id="machS1">0</span> <span class="text-sm text-gray-400">kg</span></div>
      </div>
      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400 text-[10px]">Balança - 1º Turno</div>
        <div class="text-3xl font-black mt-2 text-slate-800"><span id="scaleS1">0</span> <span class="text-sm text-gray-400">kg</span></div>
      </div>
      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400 text-[10px]">Máquinas - 2º Turno</div>
        <div class="text-3xl font-black mt-2 text-slate-800"><span id="machS2">0</span> <span class="text-sm text-gray-400">kg</span></div>
      </div>
      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400 text-[10px]">Balança - 2º Turno</div>
        <div class="text-3xl font-black mt-2 text-slate-800"><span id="scaleS2">0</span> <span class="text-sm text-gray-400">kg</span></div>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <h2 class="text-xl font-black mb-6 flex items-center gap-2 text-blue-600">
        <i data-lucide="edit-3"></i> Registrar Apontamento
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="text-xs font-black uppercase text-gray-400">Turno</label>
          <select id="shift" class="w-full mt-1 border p-3 rounded-xl font-bold outline-none bg-slate-50">
            <option value="1">1º Turno</option>
            <option value="2">2º Turno</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-black uppercase text-gray-400">Tipo de Fonte</label>
          <select id="sourceType" class="w-full mt-1 border p-3 rounded-xl font-bold outline-none bg-slate-50">
            <option value="machine">Máquina</option>
            <option value="scale">Balança</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-black uppercase text-gray-400">Equipamento</label>
          <select id="sourceId" class="w-full mt-1 border p-3 rounded-xl font-bold outline-none bg-slate-50"></select>
        </div>
        <div>
          <label class="text-xs font-black uppercase text-gray-400">Peso (Kg)</label>
          <input id="kg" type="number" step="0.001" placeholder="0.000" class="w-full mt-1 border p-3 rounded-xl font-bold outline-none bg-slate-50"/>
        </div>
      </div>
      <div class="mt-5 flex items-center gap-3">
        <button id="btnAdd" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-black hover:bg-blue-700 shadow-lg flex items-center gap-2 transition-all active:scale-95">
          <i data-lucide="plus"></i> Salvar
        </button>
        <span id="msg" class="text-sm font-bold text-gray-500"></span>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-black">Lançamentos do Dia</h2>
        <button id="btnRefreshLogs" class="text-sm font-black text-blue-600 flex items-center gap-1">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Atualizar
        </button>
      </div>
      <div class="overflow-x-auto text-left">
        <table class="w-full">
          <thead class="bg-slate-50 border-b">
            <tr>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Hora</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Turno</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Equip.</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400 text-right">Kg</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400 text-right">Ações</th>
            </tr>
          </thead>
          <tbody id="logsList" class="divide-y"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    lucide.createIcons();

    const SUPABASE_URL = "https://zujimauhxpbtmllpyfvl.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mGw-sOGtdwJoCIUAoS5hfQ_aYvKOEPn";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const fmt = (n) => Number(n || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 3 });

    function fmtTime(iso){
      const d = new Date(iso);
      return Number.isNaN(d.getTime()) ? '' : d.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    }

    let machines = [], scales = [];

    async function loadCatalog() {
      const [{ data: m }, { data: s }] = await Promise.all([
        sb.from('machines').select('id,code').eq('active', true).order('code'),
        sb.from('scales').select('id,code').eq('active', true).order('code')
      ]);
      machines = m || []; scales = s || [];
      refreshSourceDropdown();
    }

    function refreshSourceDropdown() {
      const type = el('sourceType').value;
      const list = (type === 'machine') ? machines : scales;
      el('sourceId').innerHTML = list.map(x => `<option value="${x.id}">${x.code}</option>`).join('');
    }

    async function loadTotalsByDate() {
      const prod_date = el('datePick').value;
      const { data } = await sb.from('v_prod_totals').select('*').eq('prod_date', prod_date);
      const get = (shift, type) => Number((data || []).find(x => x.shift === shift && x.source_type === type)?.total_kg || 0);
      
      const m1 = get(1,'machine'), s1 = get(1,'scale'), m2 = get(2,'machine'), s2 = get(2,'scale');
      el('machS1').innerText = fmt(m1); el('scaleS1').innerText = fmt(s1);
      el('machS2').innerText = fmt(m2); el('scaleS2').innerText = fmt(s2);
      el('machAll').innerText = fmt(m1 + m2); el('scaleAll').innerText = fmt(s1 + s2);
    }

    async function loadLogs() {
      const prod_date = el('datePick').value;
      const { data } = await sb.from('v_prod_logs_list').select('*').eq('prod_date', prod_date).order('created_at', {ascending: false});
      el('logsList').innerHTML = (data || []).map(r => `
        <tr>
          <td class="p-4 text-slate-400 font-bold">${fmtTime(r.created_at)}</td>
          <td class="p-4 font-black">${r.shift}º</td>
          <td class="p-4 font-black text-slate-600">${r.source_code}</td>
          <td class="p-4 text-right font-black text-blue-600">${fmt(r.kg)}</td>
          <td class="p-4 text-right">
            <button class="text-red-500 hover:text-red-700 p-2" onclick="deleteLog(${r.id})">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="5" class="p-4 text-center">Nenhum registro.</td></tr>`;
      lucide.createIcons();
    }

    async function deleteLog(id) {
      if (!confirm("Tem certeza que deseja apagar este lançamento?")) return;
      const { error } = await sb.from('production_logs').delete().eq('id', id);
      if (!error) await reloadAll();
    }
    window.deleteLog = deleteLog;

    async function reloadAll() {
      el('todayLabel').innerText = el('datePick').value.split('-').reverse().join('/');
      await Promise.all([loadTotalsByDate(), loadLogs()]);
    }

    async function addLog() {
      const prod_date = el('datePick').value, shift = Number(el('shift').value), sourceType = el('sourceType').value, sourceId = Number(el('sourceId').value), kg = Number(el('kg').value);
      if (!sourceId || isNaN(kg) || kg <= 0) { el('msg').innerText = "⚠️ Verifique o peso."; return; }
      
      el('btnAdd').disabled = true; el('msg').innerText = "Gravando...";
      const { error } = await sb.from('production_logs').insert([{ prod_date, shift, source_type: sourceType, source_id: sourceId, kg }]);
      el('btnAdd').disabled = false;
      
      if (!error) { 
        el('kg').value = ''; 
        el('msg').innerText = "Salvo! ✅"; 
        setTimeout(() => el('msg').innerText = "", 2000);
        await reloadAll(); 
      }
    }

    window.onload = async () => {
      const today = new Date().toISOString().slice(0,10);
      el('datePick').value = today;
      await loadCatalog();
      await reloadAll();
      el('sourceType').addEventListener('change', refreshSourceDropdown);
      el('btnAdd').addEventListener('click', addLog);
      el('datePick').addEventListener('change', reloadAll);
      el('btnHoje').addEventListener('click', () => { el('datePick').value = today; reloadAll(); });
      el('btnOntem').addEventListener('click', () => { const d = new Date(); d.setDate(d.getDate() - 1); el('datePick').value = d.toISOString().slice(0,10); reloadAll(); });
      el('btnRefreshLogs').addEventListener('click', loadLogs);
    };
  </script>
</body>
</html>
