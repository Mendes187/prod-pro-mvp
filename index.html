<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PROD PRO - Produção do Dia</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 text-gray-900">

<nav class="bg-slate-900 text-white p-4 shadow-xl">
  <div class="container mx-auto flex justify-between items-center">
    <h1 class="text-xl font-black flex items-center gap-2">
      <i data-lucide="bar-chart-3" class="text-blue-500"></i>
      PROD <span class="text-blue-500">PRO</span>
    </h1>
    <span id="today" class="text-xs font-bold text-slate-300"></span>
  </div>
</nav>

<main class="container mx-auto p-6 space-y-8">

<!-- CARDS DE TOTAIS -->
<section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">

  <div class="bg-white p-5 rounded-2xl shadow border">
    <div class="text-xs uppercase font-black text-gray-400">Máquinas 1º Turno</div>
    <div class="text-3xl font-black mt-2"><span id="machS1">0</span> kg</div>
  </div>

  <div class="bg-white p-5 rounded-2xl shadow border">
    <div class="text-xs uppercase font-black text-gray-400">Balanças 1º Turno</div>
    <div class="text-3xl font-black mt-2"><span id="scaleS1">0</span> kg</div>
  </div>

  <div class="bg-white p-5 rounded-2xl shadow border">
    <div class="text-xs uppercase font-black text-gray-400">Máquinas 2º Turno</div>
    <div class="text-3xl font-black mt-2"><span id="machS2">0</span> kg</div>
  </div>

  <div class="bg-white p-5 rounded-2xl shadow border">
    <div class="text-xs uppercase font-black text-gray-400">Balanças 2º Turno</div>
    <div class="text-3xl font-black mt-2"><span id="scaleS2">0</span> kg</div>
  </div>

</section>

<!-- RELATÓRIO FINAL -->
<section class="bg-white p-6 rounded-2xl shadow border">
  <h2 class="text-lg font-black mb-4">Relatório do Dia</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="bg-slate-50 p-4 rounded-xl border">
      <div class="text-xs font-black uppercase text-gray-400">Total 1º Turno</div>
      <div class="text-2xl font-black"><span id="totS1">0</span> kg</div>
    </div>

    <div class="bg-slate-50 p-4 rounded-xl border">
      <div class="text-xs font-black uppercase text-gray-400">Total 2º Turno</div>
      <div class="text-2xl font-black"><span id="totS2">0</span> kg</div>
    </div>

    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
      <div class="text-xs font-black uppercase text-blue-600">Total Geral</div>
      <div class="text-2xl font-black text-blue-700"><span id="totAll">0</span> kg</div>
    </div>
  </div>
</section>

<!-- LANÇAMENTO -->
<section class="bg-white p-6 rounded-2xl shadow border">
  <h2 class="text-lg font-black mb-4">Lançar Produção</h2>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">

    <div>
      <label class="text-xs font-black uppercase text-gray-400">Turno</label>
      <select id="shift" class="w-full border p-3 rounded-xl font-bold mt-1">
        <option value="1">1º Turno</option>
        <option value="2">2º Turno</option>
      </select>
    </div>

    <div>
      <label class="text-xs font-black uppercase text-gray-400">Tipo</label>
      <select id="sourceType" class="w-full border p-3 rounded-xl font-bold mt-1">
        <option value="machine">Máquina</option>
        <option value="scale">Balança</option>
      </select>
    </div>

    <div>
      <label class="text-xs font-black uppercase text-gray-400">Equipamento</label>
      <select id="sourceId" class="w-full border p-3 rounded-xl font-bold mt-1"></select>
    </div>

    <div>
      <label class="text-xs font-black uppercase text-gray-400">Kg</label>
      <input id="kg" type="number" step="0.001" min="0"
        class="w-full border p-3 rounded-xl font-bold mt-1"
        placeholder="Ex: 1200" />
    </div>

  </div>

  <button id="btnAdd"
    class="mt-4 bg-blue-600 text-white px-6 py-3 rounded-xl font-black hover:bg-blue-700">
    Adicionar
  </button>

  <p id="msg" class="mt-2 text-sm font-bold text-gray-500"></p>
</section>

</main>

<script>
lucide.createIcons();

const SUPABASE_URL = "https://zujimauhxpbtmllpyfvl.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_mGw-sOGtdwJoCIUAoS5hfQ_aYvKOEPn";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const el = (id) => document.getElementById(id);
const fmt = (n) => Number(n || 0).toLocaleString("pt-BR");

let machines = [];
let scales = [];

async function loadCatalog() {
  const { data: m } = await sb.from("machines").select("id,code").order("code");
  const { data: s } = await sb.from("scales").select("id,code").order("code");
  machines = m || [];
  scales = s || [];
  updateDropdown();
}

function updateDropdown() {
  const type = el("sourceType").value;
  const list = type === "machine" ? machines : scales;
  el("sourceId").innerHTML = list.map(x =>
    `<option value="${x.id}">${x.code}</option>`
  ).join("");
}

async function loadTotals() {
  const { data } = await sb.from("v_prod_today").select("*").single();
  if (!data) return;

  el("machS1").innerText = fmt(data.mach_s1);
  el("scaleS1").innerText = fmt(data.scale_s1);
  el("machS2").innerText = fmt(data.mach_s2);
  el("scaleS2").innerText = fmt(data.scale_s2);

  const tot1 = data.mach_s1 + data.scale_s1;
  const tot2 = data.mach_s2 + data.scale_s2;

  el("totS1").innerText = fmt(tot1);
  el("totS2").innerText = fmt(tot2);
  el("totAll").innerText = fmt(tot1 + tot2);
}

async function addLog() {
  const shift = Number(el("shift").value);
  const source_type = el("sourceType").value;
  const source_id = Number(el("sourceId").value);
  const kg = Number(el("kg").value);

  if (!kg || kg <= 0) {
    el("msg").innerText = "Informe um valor válido.";
    return;
  }

  el("btnAdd").disabled = true;
  el("msg").innerText = "Salvando...";

  const { error } = await sb.from("production_logs").insert([{
    shift,
    source_type,
    source_id,
    kg
  }]);

  el("btnAdd").disabled = false;

  if (error) {
    el("msg").innerText = "Erro ao salvar.";
    return;
  }

  el("kg").value = "";
  el("msg").innerText = "Registrado com sucesso!";
}

function startRealtime() {
  sb.channel("prod-realtime")
    .on("postgres_changes",
      { event: "*", schema: "public", table: "production_logs" },
      loadTotals
    )
    .subscribe();
}

window.onload = async () => {
  el("today").innerText = new Date().toLocaleDateString("pt-BR");
  await loadCatalog();
  await loadTotals();
  startRealtime();

  el("sourceType").addEventListener("change", updateDropdown);
  el("btnAdd").addEventListener("click", addLog);
};
</script>

</body>
</html>
