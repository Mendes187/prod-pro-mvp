<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PROD PRO - Produção do Dia (Turnos)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-50 text-gray-900">

  <nav class="bg-slate-900 text-white p-4 shadow-xl sticky top-0 z-50 border-b border-slate-800">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-black flex items-center gap-3 tracking-tighter">
        <div class="bg-blue-500/20 p-2 rounded-xl border border-blue-500/30">
          <i data-lucide="factory" class="text-blue-400 w-6 h-6"></i>
        </div>
        <span>PROD <span class="text-blue-500">PRO</span></span>
      </h1>
      
      <div class="flex items-center gap-3 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700">
        <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
        <div class="text-xs font-black text-slate-300">
          <span id="todayLabel"></span>
        </div>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-4 md:p-8 space-y-8">

    <section class="bg-white p-4 rounded-2xl border shadow-sm flex flex-wrap gap-3 items-center justify-between">
      <div>
        <div class="text-xs font-black uppercase text-gray-400">Data do apontamento</div>
        <input id="datePick" type="date" class="mt-1 border p-3 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none transition-all"/>
      </div>
      <div class="flex gap-2">
        <button id="btnOntem" class="bg-slate-100 px-5 py-3 rounded-xl font-black hover:bg-slate-200 transition-colors">
          Ontem
        </button>
        <button id="btnHoje" class="bg-slate-900 text-white px-5 py-3 rounded-xl font-black hover:bg-black transition-colors">
          Hoje
        </button>
      </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">

      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400">Produção Máquinas - 1º Turno</div>
        <div class="text-3xl font-black mt-2">
          <span id="machS1">0</span> <span class="text-sm text-gray-400">kg</span>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400">Produção Balança - 1º Turno</div>
        <div class="text-3xl font-black mt-2">
          <span id="scaleS1">0</span> <span class="text-sm text-gray-400">kg</span>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400">Produção Máquinas - 2º Turno</div>
        <div class="text-3xl font-black mt-2">
          <span id="machS2">0</span> <span class="text-sm text-gray-400">kg</span>
        </div>
      </div>

      <div class="bg-white p-6 rounded-2xl border shadow-sm">
        <div class="text-xs font-black uppercase text-gray-400">Produção Balança - 2º Turno</div>
        <div class="text-3xl font-black mt-2">
          <span id="scaleS2">0</span> <span class="text-sm text-gray-400">kg</span>
        </div>
      </div>

    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <h2 class="text-xl font-black mb-2 flex items-center gap-2">
        <i data-lucide="line-chart" class="text-gray-400 w-5 h-5"></i> Resumo Final
      </h2>
      <p class="text-sm text-gray-500 mb-6">
        Total das máquinas (soma dos dois turnos) e total das balanças (soma dos dois turnos).
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-blue-50 rounded-2xl p-5 border border-blue-100">
          <div class="text-xs font-black uppercase text-blue-700">Total produzido (Máquinas) - 1º + 2º turno</div>
          <div class="text-3xl font-black text-blue-800 mt-2">
            <span id="machAll">0</span> <span class="text-sm text-blue-600">kg</span>
          </div>
        </div>

        <div class="bg-emerald-50 rounded-2xl p-5 border border-emerald-100">
          <div class="text-xs font-black uppercase text-emerald-700">Total pesado (Balanças) - 1º + 2º turno</div>
          <div class="text-3xl font-black text-emerald-800 mt-2">
            <span id="scaleAll">0</span> <span class="text-sm text-emerald-600">kg</span>
          </div>
        </div>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <h2 class="text-xl font-black mb-2 flex items-center gap-2">
        <i data-lucide="plus-circle" class="text-blue-600 w-5 h-5"></i> Lançar Produção
      </h2>
      <p class="text-sm text-gray-500 mb-6">
        Selecione turno, tipo (máquina/balança), equipamento e informe kg. Pode lançar várias vezes ao dia.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="text-xs font-black uppercase text-gray-400">Turno</label>
          <select id="shift" class="w-full mt-1 border p-3 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="1">1º Turno</option>
            <option value="2">2º Turno</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-black uppercase text-gray-400">Tipo</label>
          <select id="sourceType" class="w-full mt-1 border p-3 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none">
            <option value="machine">Máquina</option>
            <option value="scale">Balança</option>
          </select>
        </div>

        <div>
          <label class="text-xs font-black uppercase text-gray-400">Equipamento</label>
          <select id="sourceId" class="w-full mt-1 border p-3 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none"></select>
        </div>

        <div>
          <label class="text-xs font-black uppercase text-gray-400">Kg</label>
          <input id="kg" type="number" step="0.001" min="0"
                 placeholder="Ex: 1250"
                 class="w-full mt-1 border p-3 rounded-xl font-bold focus:ring-2 focus:ring-blue-500 outline-none"/>
        </div>
      </div>

      <div class="mt-5 flex items-center gap-3">
        <button id="btnAdd" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-black hover:bg-blue-700 shadow-lg shadow-blue-100 flex items-center gap-2 transition-all active:scale-95">
          <i data-lucide="plus"></i> Adicionar
        </button>
        <span id="msg" class="text-sm font-bold text-gray-500"></span>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h2 class="text-xl font-black">Resumo por Máquina / Balança</h2>
        <button id="btnRefresh" class="text-sm font-black uppercase text-blue-600 hover:text-blue-800 flex items-center gap-2">
          <i data-lucide="refresh-cw" class="w-4 h-4"></i> Atualizar
        </button>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b">
            <tr>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Turno</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Tipo</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Equipamento</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400 text-right">Total (kg)</th>
            </tr>
          </thead>
          <tbody id="bySource" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <section class="bg-white p-6 rounded-2xl border shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <h2 class="text-xl font-black">Lançamentos (corrigir erro)</h2>
        <button id="btnRefreshLogs" class="text-sm font-black uppercase text-blue-600 hover:text-blue-800">
          Atualizar
        </button>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-50 border-b">
            <tr>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Hora</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Turno</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Tipo</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400">Equip.</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400 text-right">Kg</th>
              <th class="p-4 text-xs font-black uppercase text-gray-400 text-right">Ação</th>
            </tr>
          </thead>
          <tbody id="logsList" class="divide-y"></tbody>
        </table>
      </div>
    </section>

  </main>

  <script>
    // Inicia os ícones ao carregar
    lucide.createIcons();

    const SUPABASE_URL = "https://zujimauhxpbtmllpyfvl.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_mGw-sOGtdwJoCIUAoS5hfQ_aYvKOEPn";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const el = (id) => document.getElementById(id);
    const fmt = (n) => Number(n || 0).toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 3 });

    function fmtTime(iso){
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return '';
      return d.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    }

    let machines = [];
    let scales = [];

    async function loadCatalog() {
      const [{ data: m, error: me }, { data: s, error: se }] = await Promise.all([
        sb.from('machines').select('id,code').eq('active', true).order('code'),
        sb.from('scales').select('id,code').eq('active', true).order('code')
      ]);
      if (me) console.error(me);
      if (se) console.error(se);
      machines = m || [];
      scales = s || [];
      refreshSourceDropdown();
    }

    function refreshSourceDropdown() {
      const type = el('sourceType').value;
      const list = (type === 'machine') ? machines : scales;
      el('sourceId').innerHTML = list.map(x => `<option value="${x.id}">${x.code}</option>`).join('');
    }

    async function loadTotalsByDate() {
      const prod_date = el('datePick').value;

      const { data, error } = await sb
        .from('v_prod_totals')
        .select('shift,source_type,total_kg')
        .eq('prod_date', prod_date);

      if (error) { console.error(error); return; }

      const get = (shift, type) =>
        Number((data || []).find(x => x.shift === shift && x.source_type === type)?.total_kg || 0);

      const machS1 = get(1,'machine');
      const scaleS1 = get(1,'scale');
      const machS2 = get(2,'machine');
      const scaleS2 = get(2,'scale');

      el('machS1').innerText = fmt(machS1);
      el('scaleS1').innerText = fmt(scaleS1);
      el('machS2').innerText = fmt(machS2);
      el('scaleS2').innerText = fmt(scaleS2);

      el('machAll').innerText = fmt(machS1 + machS2);
      el('scaleAll').innerText = fmt(scaleS1 + scaleS2);
    }

    async function loadBySourceByDate() {
      const prod_date = el('datePick').value;

      const { data, error } = await sb
        .from('v_prod_by_source')
        .select('shift,source_type,source_code,total_kg')
        .eq('prod_date', prod_date);

      if (error) { console.error(error); return; }

      el('bySource').innerHTML = (data || []).map(r => `
        <tr>
          <td class="p-4 font-black text-slate-600">${r.shift === 1 ? '1º' : '2º'}</td>
          <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-xs font-bold">${r.source_type === 'machine' ? 'Máquina' : 'Balança'}</span></td>
          <td class="p-4 font-black">${r.source_code || '-'}</td>
          <td class="p-4 text-right font-black text-blue-600">${fmt(r.total_kg)}</td>
        </tr>
      `).join('') || `<tr><td class="p-6 text-center text-gray-400 font-bold" colspan="4">Sem lançamentos</td></tr>`;
    }

    async function loadLogs() {
      const prod_date = el('datePick').value;

      const { data, error } = await sb
        .from('v_prod_logs_list')
        .select('*')
        .eq('prod_date', prod_date)
        .limit(200);

      if (error) { console.error(error); return; }

      el('logsList').innerHTML = (data || []).map(r => `
        <tr>
          <td class="p-4 font-bold text-slate-500">${fmtTime(r.created_at)}</td>
          <td class="p-4 font-black">${r.shift === 1 ? '1º' : '2º'}</td>
          <td class="p-4 text-xs font-bold uppercase text-slate-400">${r.source_type === 'machine' ? 'Máquina' : 'Balança'}</td>
          <td class="p-4 font-black">${r.source_code || '-'}</td>
          <td class="p-4 text-right font-black text-slate-800">${fmt(r.kg)}</td>
          <td class="p-4 text-right">
            <button class="bg-red-50 text-red-600 border border-red-100 px-3 py-2 rounded-xl text-xs font-black hover:bg-red-600 hover:text-white transition-all"
              onclick="deleteLog(${r.id})">
              Apagar
            </button>
          </td>
        </tr>
      `).join('') || `<tr><td colspan="6" class="p-6 text-center text-gray-400 font-bold">Sem lançamentos</td></tr>`;
    }

    async function deleteLog(id) {
      if (!confirm("Tem certeza que deseja apagar este lançamento?")) return;

      const { error } = await sb.from('production_logs').delete().eq('id', id);
      if (error) { console.error(error); alert("Erro ao apagar."); return; }

      await reloadAll();
    }
    window.deleteLog = deleteLog;

    async function reloadAll() {
      el('todayLabel').innerText = el('datePick').value.split('-').reverse().join('/');
      await Promise.all([loadTotalsByDate(), loadBySourceByDate(), loadLogs()]);
      lucide.createIcons();
    }

    async function addLog() {
      const prod_date = el('datePick').value;
      const shift = Number(el('shift').value);
      const source_type = el('sourceType').value;
      const source_id = Number(el('sourceId').value);
      const kg = Number(el('kg').value);

      if (!prod_date) { el('msg').innerText = "Selecione a data."; return; }
      if (!source_id || Number.isNaN(kg) || kg <= 0) {
        el('msg').innerText = "Informe um KG válido e selecione o equipamento.";
        return;
      }

      el('btnAdd').disabled = true;
      el('msg').innerText = "Salvando...";

      const { error } = await sb.from('production_logs').insert([{
        prod_date, shift, source_type, source_id, kg
      }]);

      el('btnAdd').disabled = false;

      if (error) {
        console.error(error);
        el('msg').innerText = "Erro ao salvar (ver Console/F12).";
        return;
      }

      el('kg').value = '';
      el('msg').innerText = "Lançamento registrado ✅";
      await reloadAll();
    }

    function startRealtime() {
      sb.channel('prod-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'production_logs' }, () => reloadAll())
        .subscribe();
    }

    window.onload = async () => {
      const today = new Date().toISOString().slice(0,10);
      el('datePick').value = today;
      el('todayLabel').innerText = new Date().toLocaleDateString('pt-BR');

      await loadCatalog();
      await reloadAll();
      startRealtime();

      el('sourceType').addEventListener('change', refreshSourceDropdown);
      el('btnAdd').addEventListener('click', addLog);

      el('btnRefresh').addEventListener('click', reloadAll);
      el('btnRefreshLogs').addEventListener('click', loadLogs);

      el('datePick').addEventListener('change', reloadAll);

      el('btnHoje').addEventListener('click', () => {
        el('datePick').value = today;
        reloadAll();
      });

      el('btnOntem').addEventListener('click', () => {
        const d = new Date();
        d.setDate(d.getDate() - 1);
        el('datePick').value = d.toISOString().slice(0,10);
        reloadAll();
      });

      lucide.createIcons();
    };
  </script>

</body>
</html>
